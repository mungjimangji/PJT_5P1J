{% extends 'base.html' %}

{% load static %}

{% block title %}Detail{% endblock title %}

{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'detail/detail.css' %}">
{% endblock style %}  

{% block content %}
<article>
  <div class="Detail__Container">
    <div class="Detail__list">
      <!-- 1. 현재 영화 정보 박스 -->
      <section class="detail-item detail-item-1 Detail__TitleInfoBox">
        <div style="width: 200px; height: auto;">
          <img class="title--image" src="https://image.tmdb.org/t/p/w300{{ detail_data.poster_path }}" alt="">
        </div>
        <div>
          <div class="Detail__Title__Stat">
            <h1 class="Detail__Title__StatTitle">{{ detail_data.title }}</h1>
            <div style="font-size: 21px; margin-bottom:25px;">
              평점: <span style="color: rgb(221, 221, 0);">{{ average|floatformat:1 }}</span>
              리뷰평점: <span style="color: white;">{{ average_rating|floatformat:1 }}</span>
            </div>
            <div style="margin-bottom:10px;">{{ detail_data.release_date }} · 장르 · {{ detail_data.production_countries.0.name }}</div>
            <div style="margin-bottom:10px;">제작사: {{detail_data.production_companies.0.name }}</div>
            <div style="margin-bottom:10px;">상영시간: {{ detail_data.runtime}}분</div>
            <hr>
          </div>
          <div class="Detail__Info__WatchingBox">
            {% if request.user.is_authenticated %}
              {% comment %} 보고싶어요 폼 {% endcomment %}
              <form id="wants-form" data-post-id="{{ post.pk }}">
                {% csrf_token %}
                {% if request.user in post.want_users.all %}
                  <a type="submit" class="">
                    <i class="bi bi-eye-fill"></i>
                  </a>
          
                {% else %}
                  <a type="submit" class="">
                    <i class="bi bi-eye"></i>
                  </a>
                {% endif %}
              </form>
              {% comment %} 보는중이에요 폼 {% endcomment %}
              <form id="watching-form" data-post-id="{{ post.pk }}">
                {% csrf_token %}
                {% if request.user in post.watching_users.all %}
                  <a type="submit" class="">
                    <i class="bi bi-check-lg"></i>
                  </a>
                {% else %}
                  <a type="submit" class="">
                    <i class="bi bi-plus-lg"></i>
                  </a>
                {% endif %}
              </form>
            {% else %}
                <a class="" disabled> 
                  <i class="bi bi-plus-lg"></i>
                </a>    
            {% endif %} 
            <a class="" href="{% url 'movies:review_create' movie_id %}">리뷰쓰기</a>          
          </div>
        </div>
      </section>
      <!-- 2. 지금 여기서 보기 -->
      <section class="detail-item detail-item-2 Detail__Info__PlatformBox">
        <div class="Detail__ContentBox__Title">
          <h2>지금 여기서 보기</h2>
          <ul>
          {% for platform in platform_list %}
            {% if platform == "넷플릭스" %}
              <li class="Detail__Info__Platform">
                <div class="Detail__Info__PlatformTextBox">
                  <img class="Detail__Info__PlatformImg" src="{% static 'detail/netflix.png' %}" alt="">
                  <p class="Detail__Info__PlatformText">{{platform}}</p>
                </div>
                <button type="button" class="Detail__Info__PlatformButton"><a href="https://www.netflix.com/kr/">보러가기</a></button>
              </li>
              <hr>
              {% elif platform == "웨이브" %}
              <li class="Detail__Info__Platform">
                <div class="Detail__Info__PlatformTextBox">
                  <img class="Detail__Info__PlatformImg" src="{% static 'detail/wavve.png' %}" alt="">
                  <p class="Detail__Info__PlatformText">{{platform}}</p>
                </div>
                <button type="button" class="Detail__Info__PlatformButton"><a href="https://www.wavve.com/">보러가기</a></button>
              </li>
              <hr>
              {% elif platform == "왓챠" %}
              <li class="Detail__Info__Platform">
                <div class="Detail__Info__PlatformTextBox">
                  <img class="Detail__Info__PlatformImg" src="{% static 'detail/watcha.png' %}" alt="">
                  <p class="Detail__Info__PlatformText">{{platform}}</p>
                </div>
                <button type="button" class="Detail__Info__PlatformButton"><a href="https://watcha.com/">보러가기</a></button>
              </li>
              <hr>
              {% elif platform == "애플TV+" %}
              <li class="Detail__Info__Platform">
                <div class="Detail__Info__PlatformTextBox">
                  <img class="Detail__Info__PlatformImg" src="{% static 'detail/appletv.png' %}" alt="">
                  <p class="Detail__Info__PlatformText">{{platform}}</p>
                </div>
                <button type="button" class="Detail__Info__PlatformButton"><a href="https://www.apple.com/apple-tv-plus/">보러가기</a></button>
              </li>
              <hr>
              {% elif platform == "디즈니+" %}
              <li class="Detail__Info__Platform">
                <div class="Detail__Info__PlatformTextBox">
                  <img class="Detail__Info__PlatformImg" src="{% static 'detail/disney.jpg' %}" alt="">
                  <p class="Detail__Info__PlatformText">{{platform}}</p>
                </div>
                <button type="button" class="Detail__Info__PlatformButton"><a href="https://www.disneyplus.com/">보러가기</a></button>
              </li>
            {% endif %}
          {% endfor %}
          </ul>
        </div>
      </section>

      <!-- 3. 선호하는 태그 -->
      <section class="detail-item detail-item-3 Detail__TagAndRatingBox">
      <div class="Detail__TagBox">
        <h2 class="Detail__ContentBox__Title">선호하는 태그</h2>
        <div class="Detail__Tag">
          <div style="width: 50%; padding:10px;">
            <p>태그 : 
              {% for tag, count in total_tags.items %}
              <span class="badge rounded-pill text-bg-light"> {{tag}} <b>{{count}}</b> </span>
              {% endfor %}
            </p>
          </div>
          
          <div class="TagRank" style="position: relative; width: 50%;">
          </div>
        </div>
      </div>
      </section>

      <!-- 4. 별점그래프 -->
      <section class="detail-item detail-item-4 Detail__RatingBox">
        <div class="Detail__ContentBox__GraphTitle">
          <h2 class="Detail__ContentBox__Title">별점그래프</h2>
          <div class="">
            <p>평균 ★ {{ average_rating|floatformat:1 }}</p>
            <p>(리뷰: {{ reviews.count }})</p>
          </div>
        </div>
        <div>
          <ul class="bar-chart">
            <li class="bar-chart__bar" style="height: 0;"></li>
            <li class="bar-chart__bar" style="height: 0;"></li>
            <li class="bar-chart__bar" style="height: 0;"></li>
            <li class="bar-chart__bar" style="height: 0;"></li>
            <li class="bar-chart__bar" style="height: 0;"></li>
          </ul>
          <ul class="bar-chart__text">
            <li class="bar-chart__barText">1</li>
            <li class="bar-chart__barText">2</li>
            <li class="bar-chart__barText">3</li>
            <li class="bar-chart__barText">4</li>
            <li class="bar-chart__barText">5</li>
          </ul>
        </div>
      </section>
      <!-- 5. 정보, 출연/제작 -->
      <section class="detail-item detail-item-5 Detail__ContentBox">
      <div>
        <h2 class="Detail__ContentBox__Title">정보</h2>
        <p style="margin: 0 15px 0 15px;">{{ detail_data.overview }}</p>
      </div>
      <hr>
      <div class="row">
        <h2 class="Detail__ContentBox__Title">출연/제작</h2>
        <div class="row" >
          {% for credit in credits %}
            <div class="col-3" style="width:150px; height:150px; object-fit:hidden"> 
              {% if credit.profile_path %}
                <img  style="object-fit:cover; width:100%; height:100%" src="https://image.tmdb.org/t/p/w200/{{ credit.profile_path }}" alt="{{credit.name}}사진">
              {% else %}
                <p>static에 기본 사진 넣으시면 될 것 같습니다~! </p> 
              {% endif %}
              <p>{{ credit.name }}</p>
              <p class='text-secondary'>{{ credit.character }} 역</p>  
            </div>
          {% endfor %}
        </div>
      </div>
      </section>

      <!-- 6. 리뷰스 -->
      <section class="detail-item detail-item-6 Detail__ReviewBox">
        <h2 class="Detail__ContentBox__Title">리뷰</h2>
        <a id="load-more-btn" class="load-more-btn">더보기</a>
        {% comment %} 리뷰 출력 {% endcomment %}
        <ul>
          <!-- 리뷰 -->
          {% for review in reviews reversed %}
          <li class="Detail__Review" style="{% if forloop.counter0 <= 4 %}display: grid; {% else %}display: none; {% endif %}">
            <!-- 1. 유저, 콘텐츠-->
            <div class="detail__review__user--content">
              <!-- 1-1. 유저 -->
              <a class="detail__user--wrap" href="{% url 'accounts:profile' review.user %}">
                <div class="Detail__Review__UserInfo">
                  {% if review.user.picture %}
                  <div class="Detail__Review__User__ImgBox">
                    <img class="Detail__Review__User__Img" src="{{ review.user.picture.url }}" alt="유저 이미지">
                  </div>
                  {% else %}
                  <div class="Detail__Review__User__ImgBox">
                    <img class="Detail__Review__User__Img noimage" src="{% static 'img/accounts/cidia_profile_noimage_02.png' %}" alt="유저 이미지 없음">
                  </div>
                  {% endif %}
                  <span class="Detail__Review__User__Name">{{ review.user }}</span>
                  <ul class="Detail__Review__User__Stat">
                    <span class="Detail__Review__User__StatItem--Review"></span><li class="Detail__Review__User__StatItem">{{ review.user.review_set.all|length }}</li>
                    <span class="Detail__Review__User__StatItem--Follower"></span><li class="Detail__Review__User__StatItem">{{ review.user.followers.all|length }}</li>
                  </ul>
                </div>
              </a>
              <!-- 1-2. 콘텐츠 -->
              <div class="Detail__Review__Content">
                <div class="Detail__Review__Rating">
                  <i class="bi bi-star-fill"></i>
                  <p id="rate" style="margin-left:5px;">{{ review.rating }}</p>
                  <p> · </p>
                  {% comment %} 좋아요 비동기 하기 {% endcomment %}
                  <form id="review-like" data-movie-id="{{ movie.id }}" data-review-id="{{ review.pk }}">
                    {% csrf_token %}
                    <button type="submit" style="margin-left:5px; color: #7048E9;">좋아요 {{ review.like_users|length }}</button>
                  </form>
                  <p> · </p>
                  <p style="margin-left:5px;">댓글 {{ review.comment_set.all|length }} </p>
                </div>
                <div class="detail--review--content">
                  {% if review.spoiler == 1 %}
                    <div class="Review__Spoiler--Active"style="display: block;">
                      <p>스포일러 내용이 포함되어 있습니다. <button class="SpoilerNone--Btn" onclick="toggleSpoiler(this)">더보기</button></p>
                    </div>
                    <div class="Review__Spoiler--None" style="display: none;">
                      <a href="{% url 'movies:review_detail' movie_id review.pk %}">
                        <p>{{ review.content }}</p>
                      </a>
                    </div>
                  {% else %}
                    <div class="Review__Spoiler--None" style="display: block;">
                      <a href="{% url 'movies:review_detail' movie_id review.pk %}">
                        <p>{{ review.content }}</p>
                      </a>
                    </div>
                  {% endif %}
                </div>
                <div class="Detail__Review__Tags">
                    {% for tags1 in r_tags_list reversed %}
                      {% if forloop.parentloop.counter == forloop.counter %}
                        {% for tag in tags1 %}
                          <span class="badge rounded-pill text-bg-light">{{ tag }}</span>
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                </div>
              </div>
            </div>
            <!-- 2. 신고 삭제 수정-->
            <div class="Detail__Review__Etc">
              {{ review.created_at|date:"Y. m. d" }}
              <div class="d-flex flex-row RemoveandUpdate">
                {% if request.user == review.user %}
                  <a href="{% url 'movies:review_delete' movie_id review.pk %}" onclick="return confirm('삭제하시겠습니까?')"><button style="color:#7048E9;">삭제</button></a>
                  <p style="color:#7048E9; margin: 0 5px 0 5px;">·</p>
                  <a href="{% url 'movies:review_update' post.movie_id review.pk %}"><button style="color:#7048E9;">수정</button></a>
                {% else %}
                  <a href="{% url 'movies:review_report' post.movie_id review.pk %}"><button style="color:#7048E9;">신고하기</button></a>
                {% endif %}
              </div>
            </div>
          </li>  
          {% endfor %}
        </ul>
      </section>

      <!-- 7. 비슷한 작품 -->
      <section class="detail-item detail-item-7 Detail__SimilarBox">
      <h2 class="Detail__ContentBox__Title">비슷한 작품</h2>
      <div class="Detail__Content__Similar">
        <div class="Detail__carousel">
          {% for similar in similars %}
            <a class="movie-link" href="{% url 'movies:detail' similar.id %}">
              <div class="Detail__Card" style="width: 193px;">
                <div class="card" style="width: 173px; height: 255px; position: relative; overflow: hidden;">
                  <img src="https://image.tmdb.org/t/p/w300{{ similar.poster_path }}" alt="">
                </div>
                <div class="Detail__Card__Content">
                  <div class="card-title" style="color: white;">{{ similar.title }}</div>
                  {% if request.user.is_superuser %}
                  <span><a href="{% url 'movies:create' similar.id %}">생성하기</a></span>
                  {% endif %}
                </div>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
      </section>
    </div>
  </div>
</article>
    

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


{% endblock content %}
{% block script %}
<script>
  // 드래그 앤 드롭
  document.addEventListener('DOMContentLoaded', function() {
    var carousel = document.querySelector('.Detail__carousel');
    var cards = document.querySelector('.card');
    var isDragging = false;
    var startX, cardStartX;
  
    carousel.addEventListener('mousedown', function(e) {
      isDragging = true;
      startX = e.pageX - carousel.offsetLeft;
    });
  
    carousel.addEventListener('mouseup', function() {
      isDragging = false;
    });
  
    carousel.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      e.preventDefault();
      var x = e.pageX - carousel.offsetLeft;
      var walk = x - startX;
  
      carousel.scrollLeft -= walk;
    });
  });

  // carousel 자동 스크롤
  const DetailcarouselElement = document.querySelector('.Detail__carousel');
  let direction = 1; // 스크롤 방향 설정 (1: 오른쪽으로, -1: 왼쪽으로)
  let scrollInterval;

  function handleScroll() {
    const DetailscrollPosition = DetailcarouselElement.scrollLeft;
    const DetailcontainerWidth = DetailcarouselElement.offsetWidth;
    const DetailcontentWidth = DetailcarouselElement.scrollWidth;
    

    // 스크롤이 왼쪽 끝에 도달했을 때
    if (scrollPosition === 0) {
      direction = 1; // 오른쪽으로 스크롤
    }

    // 스크롤이 오른쪽 끝에 도달했을 때
    //if (scrollPosition + containerWidth === contentWidth) {
    //  direction = -1; // 왼쪽으로 스크롤
    //}
  }

  function startAutoScroll() {
    scrollInterval = setInterval(() => {
      DetailcarouselElement.scrollBy({
        left: direction * 1, // 스크롤 속도 조절
        behavior: 'smooth',
      });
    }, 3000); // 스크롤 간격 조절
  }

  function stopAutoScroll() {
    clearInterval(scrollInterval);
  }

  // 페이지 로딩 시 자동 스크롤 시작
  window.addEventListener('load', () => {
    startAutoScroll();
  });

  // 마우스가 캐러셀 위로 진입했을 때 자동 스크롤 일시 정지
  DetailcarouselElement.addEventListener('mouseenter', () => {
    stopAutoScroll();
  });

  // 마우스가 캐러셀에서 벗어났을 때 자동 스크롤 재개
  DetailcarouselElement.addEventListener('mouseleave', () => {
    startAutoScroll();
  });

  // 예시: 1점부터 5점까지 선택한 수
  var ratings = [0, 0, 0, 0, 0]
  var ratingElements = document.querySelectorAll('#rate');
  ratingElements.forEach(function(element) {
    var rating = element.textContent;
    if (!isNaN(rating)) {
      ratings[rating - 1] += 1;
      console.log(rating)
    }
  });
  
  var maxRating = Math.max(...ratings)

  const bars = document.querySelectorAll('.bar-chart__bar');
  bars.forEach((bar, index) => {
    const rating = ratings[index];
    
    const heightPercentage = (rating / maxRating) * 100;
    
    bar.style.height = `${heightPercentage}%`;

    if (rating === maxRating) {
      bar.style.backgroundColor = 'rgb(112, 72, 233)'; // 가장 높은 값에 대한 색상을 변경
    }
    
  });
  // 보고싶어요 비동기
  const form = document.querySelector('#wants-form')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
  form.addEventListener('submit', function (event) {
    event.preventDefault()
    const postId = event.target.dataset.postId
    axios({
      method: 'post',
      url: `/movies/${postId}/wants/`,
      headers: {'X-CSRFToken': csrftoken},
    })
      .then((response) => {
        const isWanted = response.data.is_wanted
        const wantBtn = document.querySelector('#wants-form > button[type=submit]')
        const wantBtni = document.querySelector('#wants-form > button[type=submit] > i')
       
        if (isWanted === true) {
          wantBtni.classList.remove('bi-eye')
          wantBtni.classList.add('bi-eye-fill') 
        } else {
          wantBtni.classList.remove('bi-eye-fill')
          wantBtni.classList.add('bi-eye')  
        }
      })
      .catch((error) => {
      console.log(error.response)
    })
  })
  // 보는 중이에요 비동기
  const form1 = document.querySelector('#watching-form')
  const csrftoken1 = document.querySelector('[name=csrfmiddlewaretoken]').value
  form1.addEventListener('submit', function (event) {
    event.preventDefault()
    const postId = event.target.dataset.postId
    axios({
      method: 'post',
      url: `/movies/${postId}/watchings/`,
      headers: {'X-CSRFToken': csrftoken1},
    })
      .then((response) => {
        const watching = response.data.watching
        // 보는중이에요 폼 버튼 변수 설정했습니다 원하시는 대로 클래스 추가해주세요ㅎㅎ 아이콘도 바꾸셔도 됩니다
        const watchingBtn = document.querySelector('#watching-form > button[type=submit]')
        const watchingBtni = document.querySelector('#watching-form > button[type=submit] > i')
        if (watching === true) {
          watchingBtni.classList.remove('bi-plus-lg')
          watchingBtni.classList.add('bi-check-lg')     
        } else {
          watchingBtni.classList.remove('bi-check-lg')
          watchingBtni.classList.add('bi-plus-lg') 
        }
        
      })
  }) 

  // 좋아요 비동기
  {% comment %} const form2 = document.querySelector('#review-like')
  const csrftoken2 = document.querySelector('[name=csrfmiddlewaretoken]').value
  form1.addEventListener('submit', function (event) {
    event.preventDefault()
    const movieId = event.target.dataset.movieId
    console.log(movieId)
    const reviewId = event.target.dataset.reviewId
    console.log(reviewId)
    axios({
      method: 'post',
      url: `/movies/${movieId}/reviews/${reviewId}/like/`,
      headers: {'X-CSRFToken': csrftoken1},
    })
      .then((response) => {
        const reviewLike = response.data.is_liked
      })
  })  {% endcomment %}

  // 더보기
  var loadMoreBtn = document.getElementById('load-more-btn');
  var reviews = document.querySelectorAll('.Detail__ReviewBox .Detail__Review');
  var hiddenReviewsCount = {{ reviews|length }} - 5;  
  var currentDisplayCount = 5;
  

  function loadMoreBtnClick() {
    for (var i = currentDisplayCount; i < currentDisplayCount + 5 && i < reviews.length; i++) {
      reviews[i].style.display = 'block';
    }

    currentDisplayCount += 5;

    if (currentDisplayCount >= reviews.length) {
      loadMoreBtn.innerText = '닫기'; // 버튼 텍스트를 '닫기로 변경'
      loadMoreBtn.classList.remove('load-more-btn')
      loadMoreBtn.classList.add('load-close-btn')

      loadMoreBtn.removeEventListener('click', loadMoreBtnClick); // 이벤트 제거
      loadMoreBtn.addEventListener('click', closeMoreBtnClick); // 닫기 버튼 클릭 이벤트 추가
    }
  };

  if (hiddenReviewsCount <= 0) {
    loadMoreBtn.style.display = 'none';
  }

  // 닫기 버튼 클릭 시
  
  function closeMoreBtnClick() {
    for (var i = 5; i < reviews.length; i++) {
      reviews[i].style.display = 'none';
    }
  
    currentDisplayCount = 5;
    loadMoreBtn.innerText = '더보기';  // 버튼 텍스트를 '더보기'로 변경
    loadMoreBtn.classList.add('load-more-btn')
    loadMoreBtn.classList.remove('load-close-btn')

    loadMoreBtn.removeEventListener('click', closeMoreBtnClick); // 이벤트 제거
    loadMoreBtn.addEventListener('click', loadMoreBtnClick); // 더보기 버튼 클릭 이벤트 추가
     
  };

  loadMoreBtn.addEventListener('click', loadMoreBtnClick); // 초기에 더보기 버튼 클릭 이벤트 추가

  function toggleSpoiler(button) {
    var spoilerActive = button.parentNode.parentNode;
    var spoilerNone = spoilerActive.nextElementSibling;

    spoilerActive.style.display = 'none';
    spoilerNone.style.display = 'block';
  }
  
  // 태그 생성
  function getRandomTransform() {
    const translateXRange = 100; // X 축 이동 범위
    const translateYRange = 100; // Y 축 이동 범위
    const tagElements = [];
    for (let i = 1; i <= 5; i++) {
      const tagElement = document.getElementById(`tag${i}`);
      tagElements.push(tagElement);
    }
    const numTags = tagElements.length;
  
    // 이전에 생성된 위치를 추적하는 배열
    const previousPositions = [];
  
    for (let i = 0; i < numTags; i++) {
      let positionFound = false;
      let translateX, translateY, rotate;
  
      // 최대 시도 횟수 동안 겹치지 않는 위치를 찾습니다.
      const maxAttempts = 100;
      let attempts = 0;
  
      while (!positionFound && attempts < maxAttempts) {
        translateX = Math.floor(Math.random() * translateXRange) + 100;
        translateY = Math.floor(Math.random() * translateYRange) + 30;
  
        // 현재 위치와 이전에 생성된 위치를 비교하여 겹치지 않는지 확인합니다.
        const currentPosition = { x: translateX, y: translateY };
        const overlapping = previousPositions.some((prevPosition) =>
          isOverlapping(currentPosition, prevPosition)
        );
  
        if (!overlapping) {
          positionFound = true;
          previousPositions.push(currentPosition);
        }
  
        attempts++;
      }
  
      // 겹치지 않는 위치를 찾지 못한 경우, 기본 위치를 설정합니다.
      if (!positionFound) {
        translateX = 100 + i * 30; // 기본 위치 설정
        translateY = 30;
      }
  
      const transform = `translate(${translateX}px, ${translateY}px) rotate(0deg)`;
      const tagElement = tagElements[i];
      tagElement.style.position = "absolute";
      tagElement.style.fontSize = "17px";
      tagElement.style.fontWeight = "bold";
      tagElement.style.lineHeight = "23px";
      tagElement.style.color = "white";
      tagElement.style.transform = transform;
      tagElement.style.fontFamily = "Noto Sans KR";
      tagElement.style.fontStyle = "normal";
      tagElement.style.textAlign = "center";
      tagElement.style.transformOrigin = "center bottom";
      tagElement.style.whiteSpace = "nowrap";
      tagElement.style.width = `${tagElement.offsetWidth}px`;
    }
  }
  
  // 두 위치가 겹치는지 확인하는 함수
  function isOverlapping(pos1, pos2) {
    const x1 = pos1.x;
    const y1 = pos1.y;
    const x2 = pos2.x;
    const y2 = pos2.y;
  
    return Math.abs(x1 - x2) < 100 && Math.abs(y1 - y2) < 30; // 위치 조건을 조정해야 할 수도 있습니다.
  }
  
  // getRandomTransform 함수 호출
  getRandomTransform();

</script>

{% endblock script %}
